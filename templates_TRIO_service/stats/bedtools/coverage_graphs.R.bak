library(ggplot2)
library(RColorBrewer)
brewer_qualitative <- c("#0000ff","#ff0000","#483215","#008900","#7244c4","#e65a11","#000000","#e6e528","#ff00ee","#6e0000","#00c7dd","#d4b455","#8f008d","#736b00","#7d8cbf")

len_reads <- 81

## GRAPH COVERAGE HIST OF TARGET
# get file names
print(files <- list.files(pattern="covhist_graph.csv$"),recursive=T)

# load and parse the files
cov<-NULL
for (f in files){
 	df=read.table(f, sep="\t")
	colnames(df)=c("Feature","covThreshold","FractionWithCov","FractionLength","diffFracBelowThreshold")
	df$fracAboveThreshold=1-cumsum(df$diffFracBelowThreshold)
 	cov=rbind(cov,cbind(df, sample= gsub("(ND048[1-3]).*$", "\\1", f)))
}

# plot the data
maxCov=400
p2<-ggplot(subset(cov, covThreshold<maxCov), aes(x= covThreshold, y=100*fracAboveThreshold, color=sample)) +
geom_line() +
ylim(0, 100) +
scale_color_manual(values=brewer_qualitative) +
scale_x_continuous(breaks=seq(0,maxCov,by=10)) +
scale_y_continuous(breaks=seq(0,100,by=10)) +
theme_bw() +
theme(axis.text.x = element_text(size = 10.5,angle=75, vjust=0.5), strip.text.x = element_text(size=6.5)) +
labs(title="Genome Coverage", x="Depth of coverage", y="Percentage of coverage")

pdf(file="coverage_graph.pdf",width=15)
print(p2)
dev.off()

cov_table <- by(cov,cov[,"sample"],function(x) x$fracAboveThreshold[x$covThreshold == 10 | x$covThreshold==20 | x$covThreshold== 30 | x$covThreshold == 50])
cov_table <- do.call(rbind,cov_table)
colnames(cov_table) = c("10x","20x","30x","50x")
write.table(cov_table,file="coverage_table.csv",sep="\t")

## DETECT EXONS WITH LACK OF COVERAGE

cov <- NULL
print(files <- list.files(pattern="cov.csv$"),recursive=T)

for (f in files){
  	df=read.csv(f, sep="\t",quote="",header=F)
 	colnames(df)=c("chromosome","start","end","strand","description","number_reads_overlap","number_bases_covered","length","fraction_covered")
 	df$mean_coverage=(df$number_reads_overlap*len_reads)/df$length
  	cov=rbind(cov,cbind(df, sample= gsub("(ND048[1-3]).*$", "\\1", f)))
}


coverage_stats <- by(cov,cov[,"sample"],function(x){ p <- nrow(x[x$mean_coverage < 20,])
													fn <- p/nrow(x)
													f <- 1-fn
													return(c(p,f,fn))})

coverage_stats <- do.call(rbind,coverage_stats)
colnames(coverage_stats) = c("exons_below_20","fr_covered","fr_NOT_covered")
write.table(coverage_stats,file="exons_not_covered_stats.csv",sep="\t")

exons_below_20 <- by(cov,cov[,"sample"],function(x){ p <- x[x$mean_coverage < 20,]
					 								 p <- p[complete.cases(p),]
					 								 name <- paste(unique(p$sample),"_exons_below20.txt",sep="")
					 								 print(name)
													 write.table(p,file=name,row.names=F)
													})
